<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game Result</title>
    <link rel="stylesheet" href="/static/css/summary.css">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
</head>
<body>


    <div class="result-container">
        <h1>ğŸ‰ éŠæˆ²å®Œæˆï¼ </h1>
        <!-- <div class="personality-image-container">
            <img class="personality-image" src="/static/picture/{{personality_animal}}.png">
        </div> -->
        <div class="personality-result">
            <h2>çµæœåˆ†æ: <span id="personalityType" class="highlight-personality">{{personality_description}}</span></h2>    
            <p>ï¼ˆé»æ“Šæƒ…ç·’æ¨™ç±¤ç¯©é¸åœ–ç‰‡ï¼Œé»æ“Šåœ–ç‰‡æŸ¥çœ‹è©³ç´°è³‡è¨Šï¼‰</p>
        </div>
        
        <div class="performance-summary">
            <div class="emotion-legend">
                <div class="legend-item" data-filter="all">
                    <span class="color-swatch all"></span>
                    <span class="legend-text">å…¨éƒ¨</span>
                </div>
                {% if user_percentages is defined %}
                <div class="legend-item" data-filter="è¼•è”‘">
                    <span class="color-swatch contempt"></span>
                    <span class="legend-text">è¼•è”‘ {{ user_percentages['è¼•è”‘'] }}%</span>
                </div>
                <div class="legend-item" data-filter="æ†¤æ€’">
                    <span class="color-swatch anger"></span>
                    <span class="legend-text">æ†¤æ€’ {{ user_percentages['æ†¤æ€’'] }}%</span>
                </div>
                <div class="legend-item" data-filter="å­æƒ¡">
                    <span class="color-swatch disgust"></span>
                    <span class="legend-text">å­æƒ¡ {{ user_percentages['å­æƒ¡'] }}%</span>
                </div>
                <div class="legend-item" data-filter="å…¶ä»–">
                    <span class="color-swatch others"></span>
                    <span class="legend-text">å…¶ä»– {{ user_percentages['å…¶ä»–'] }}%</span>
                </div>
                {% endif %}
            </div>
        </div>
        
        
        <div class="analysis-table">
            {% if all_items|length > 0 %}
            <div class="image-grid">
                {% for item in all_items %}
                <div class="image-item" data-emotion="{{ item.choice }}">
                    <span class="image-number">{{ loop.index }}</span>
                    <div class="image-thumbnail-container">
                        <img src="/summary/images/{{ item.image }}" alt="è¿·å› " class="thumbnail" onclick="openModal(this, '{{ item.choice }}')">
                        <div class="emotion-overlay emotion-{{ item.choice|emotion_class }}"></div>
                    </div>
                    <!-- Progress bars are now hidden by default and shown in the modal -->
                    <div class="progress-bar-container" style="display:none;">
                        {% for option in ['è¼•è”‘', 'æ†¤æ€’', 'å­æƒ¡', 'å…¶ä»–'] %}
                        <div class="progress-bar-wrapper {{ option|emotion_class }}-bar {% if item.choice == option %}user-choice-wrapper{% endif %}">
                            <div class="progress-bar" style="width: {{ item.percentages[option] }}%;"></div>
                            <div class="progress-bar-text">
                                {{ option }} {% if item.choice == option %}{% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
                <p class="no-data">ç›®å‰æ²’æœ‰å¯ä¾›åˆ†æçš„åœ–ç‰‡æ•¸æ“šã€‚</p>
            {% endif %}
        </div>
        
        
        <div class="footer">
            <div class="lottery-section">
                <div class="lottery-header">
                    <h2>ğŸ æŠ½çæ´»å‹•</h2>
                </div>
                
                <div class="lottery-content">
                    <p>éå¸¸æ„Ÿè¬æ‚¨çš„åƒèˆ‡ï¼æˆ‘å€‘æº–å‚™äº† 50 ä»½ 7-Eleven 100 å…ƒæ•¸ä½å•†å“ç¦®åˆ¸ä½œç‚ºå›é¥‹ã€‚<br>
                    ç•™ä¸‹ Email ä¸¦é»æ“Šã€Œå®Œæˆã€å°±æœ‰æ©Ÿæœƒä¸­çï¼ï¼ˆEmail åƒ…ç”¨æ–¼è¯çµ¡ä¸­çè³‡è¨Šï¼Œä¸ä½œå…¶ä»–ç”¨é€”ï¼‰<br>
                    
                    <p>
                        è‹¥æœ‰ä»»ä½•å•é¡Œï¼Œæ­¡è¿éš¨æ™‚è¯çµ¡<br>
                        è² è²¬äººï¼šåœ‹ç«‹é™½æ˜äº¤é€šå¤§å­¸ è³‡è¨Šç§‘å­¸èˆ‡å·¥ç¨‹ç ”ç©¶æ‰€ å‘‚è¼ç¿°<br>
                        <a href="mailto:deehuihan.cs11@nycu.edu.tw">deehuihan.cs11@nycu.edu.tw</a> <br>
                        æŒ‡å°æ•™æˆï¼šåœ‹ç«‹é™½æ˜äº¤é€šå¤§å­¸ è³‡è¨Šå·¥ç¨‹å­¸ç³» å¼µæ°¸å„’ æ•™æˆ<br>
                        <a href="mailto:armuro@nycu.edu.tw">armuro@nycu.edu.tw</a>
                    </p>  
                    
                    <div class="email-container">
                        <form id="email-form" action="{{ url_for('save_email', player_name=player_name) }}" method="post">
                            <div class="input-group">
                                <div class="input-icon">âœ‰ï¸</div>
                                <input type="email" id="email-input" name="email" placeholder="æ‚¨çš„ Email" required>
                            </div>
                            
                            <div class="participation-container">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="participation-checkbox" name="participation" value="yes">
                                    <span class="custom-checkbox"></span>
                                    <span>è‹¥æ‚¨å°å¾ŒçºŒçš„è¿·å› å­¸è¡“ç ”ç©¶æ„Ÿèˆˆè¶£ï¼Œæˆ‘å€‘å°‡é€éæ‚¨æä¾›çš„ Email èˆ‡æ‚¨è¯ç¹«ã€‚</span>
                                </label>
                                <input type="hidden" name="participation" value="no">
                            </div>

                            <button type="submit" class="submit-button">å®Œæˆ</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Modal for image zoom with progress bars -->
    <div id="imageModal" class="image-modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-content-container">
            <div class="modal-image-container">
                <img class="modal-content" id="modalImage">
            </div>
            <div class="modal-progress-container" id="modalProgress">
                <div class="progress-bars-title">
                    <div class="progress-title-main">å¤§å®¶çš„é¸æ“‡</div>
                    <div class="progress-title-subtitle">æ¯å€‹é•·æ¢ä»£è¡¨äº†ä¸åŒè§€é»çš„æ¯”ä¾‹ï¼Œæ¡†èµ·ä¾†çš„æ˜¯æ‚¨çš„é¸æ“‡</div>
                    <div class="progress-legend">
                        <span class="mini-swatch contempt"></span>
                        <span class="mini-swatch anger"></span>
                        <span class="mini-swatch disgust"></span>
                        <span class="mini-swatch others"></span>
                    </div>
                </div>
                <!-- Progress bars will be added here dynamically -->
            </div>
        </div>
    </div>

    <!-- Email Submission Popup -->
    <div id="emailPopup" class="email-popup">
        <div class="email-popup-content">
            <p>æ„Ÿè¬æ‚¨çš„åƒèˆ‡ï¼</p>
            <div class="popup-buttons">
                <button onclick="closePopup()">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        // Remove the toggleBlock function since we're not using collapsible blocks anymore
        
        function openModal(imgElement, userChoice) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalProgress = document.getElementById('modalProgress');
            
            // Get the image item element (parent of the clicked image)
            const imageItem = imgElement.closest('.image-item');
            
            // Get the progress bar container from the image item
            const progressContainer = imageItem.querySelector('.progress-bar-container');
            
            // Clear previous content except the title
            const progressTitle = modalProgress.querySelector('.progress-bars-title');
            modalProgress.innerHTML = '';
            modalProgress.appendChild(progressTitle);
            
            // Clone the progress bar container and add it to the modal
            if (progressContainer) {
                const clone = progressContainer.cloneNode(true);
                clone.style.display = 'block';
                modalProgress.appendChild(clone);
            }
            
            modal.style.display = 'flex';
            modalImg.src = imgElement.src;
        }
    
        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
        }
    
        document.getElementById('email-form').addEventListener('submit', function(e) {
            e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡¨å•æäº¤è¡Œä¸º
        
            const formData = new FormData(this);
        
            // ä½¿ç”¨ fetch æäº¤è¡¨å•
            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    // æ˜¾ç¤ºå¼¹å‡ºæ¡†
                    document.getElementById('emailPopup').style.display = 'flex';
                } else {
                    // å¤„ç†é”™è¯¯
                    alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        });
    
        // é—œé–‰å½ˆå‡ºæ¡†ä¸¦è·³è½‰åˆ° terms.html
        function closePopup() {
            document.getElementById('emailPopup').style.display = 'none';
            window.location.href = '/'; // è·³è½‰åˆ° terms.html
        }
    
        // Filter images by emotion
        document.querySelectorAll('.legend-item').forEach(item => {
            item.addEventListener('click', function() {
                const filter = this.getAttribute('data-filter');
                
                // Remove active class from all legend items
                document.querySelectorAll('.legend-item').forEach(el => {
                    el.classList.remove('active');
                });
                
                // Add active class to clicked item
                this.classList.add('active');
                
                // Filter the image grid
                const imageItems = document.querySelectorAll('.image-item');
                imageItems.forEach(img => {
                    if (filter === 'all' || img.getAttribute('data-emotion') === filter) {
                        img.style.display = '';
                    } else {
                        img.style.display = 'none';
                    }
                });
            });
        });
        
        // Initialize with "all" selected
        document.querySelector('.legend-item[data-filter="all"]').classList.add('active');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMå·²åŠ è¼‰ï¼Œæº–å‚™ç¶å®šåˆ†äº«æŒ‰éˆ•äº‹ä»¶');
            
            // ç²å–åˆ†äº«æŒ‰éˆ•å…ƒç´ 
            const shareBtn = document.getElementById('shareResultsBtn');
            
            // æª¢æŸ¥æŒ‰éˆ•å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (shareBtn) {
                console.log('æˆåŠŸæ‰¾åˆ°åˆ†äº«æŒ‰éˆ•å…ƒç´ ');
                
                // ç¶å®šé»æ“Šäº‹ä»¶
                shareBtn.addEventListener('click', function() {
                    console.log('åˆ†äº«æŒ‰éˆ•è¢«é»æ“Š');
                    const shareUrl = `${window.location.origin}`;
                    console.log('æº–å‚™è¤‡è£½é€£çµ:', shareUrl);
                    
                    try {
                        navigator.clipboard.writeText(shareUrl)
                            .then(() => {
                                console.log('è¤‡è£½æˆåŠŸ');
                                // ç¢ºä¿modalSuccesså‡½æ•¸å­˜åœ¨
                                showCopySuccessModal('å·²è¤‡è£½éŠæˆ²é€£çµï¼å°‡æ­¤é€£çµåˆ†äº«çµ¦æœ‹å‹å³å¯é–‹å§‹éŠæˆ²');
                            })
                            .catch(err => {
                                console.error('è¤‡è£½å¤±æ•—: ', err);
                                // ä½¿ç”¨å‚™ç”¨è¤‡è£½æ–¹æ³•
                                fallbackCopyTextToClipboard(shareUrl);
                            });
                    } catch (err) {
                        console.error('è¤‡è£½å‡ºéŒ¯: ', err);
                        fallbackCopyTextToClipboard(shareUrl);
                    }
                });
            } else {
                console.error('æœªæ‰¾åˆ°IDç‚ºshareResultsBtnçš„æŒ‰éˆ•å…ƒç´ ');
            }
        });
        
        function fallbackCopyTextToClipboard(text) {
            console.log('ä½¿ç”¨å‚™ç”¨è¤‡è£½æ–¹æ³•');
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            textArea.style.position = "fixed";
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.width = "2em";
            textArea.style.height = "2em";
            textArea.style.padding = "0";
            textArea.style.border = "none";
            textArea.style.outline = "none";
            textArea.style.boxShadow = "none";
            textArea.style.background = "transparent";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    console.log('å‚™ç”¨è¤‡è£½æ–¹æ³•æˆåŠŸ');
                    showCopySuccessModal('âœ… å·²è¤‡è£½éŠæˆ²é€£çµï¼\n\nè«‹åˆ†äº«çµ¦æœ‹å‹ä¸€èµ·ä¾†ç© ğŸ®');
                } else {
                    console.error('å‚™ç”¨è¤‡è£½æ–¹æ³•å¤±æ•—');
                    prompt('è«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹å…§å®¹åˆ†äº«çµ¦æœ‹å‹ï¼š', text);
                }
            } catch (err) {
                console.error('å‚™ç”¨è¤‡è£½æ–¹æ³•å‡ºéŒ¯', err);
                prompt('è«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹å…§å®¹åˆ†äº«çµ¦æœ‹å‹ï¼š', text);
            }
            
            document.body.removeChild(textArea);
        }

        // ç¡®ä¿showCopySuccessModalå‡½æ•°æ­£ç¡®å®šä¹‰
        function showCopySuccessModal(message) {
            console.log('é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯:', message);
            let successModal = document.getElementById('copySuccessModal');
            
            if (!successModal) {
                successModal = document.createElement('div');
                successModal.id = 'copySuccessModal';
                successModal.className = 'copy-success-modal';
                successModal.innerHTML = `<div class="copy-success-content">${message}</div>`;
                document.body.appendChild(successModal);
            } else {
                successModal.querySelector('.copy-success-content').textContent = message;
            }
            
            successModal.style.display = 'flex';
            
            setTimeout(() => {
                successModal.style.opacity = '0';
                setTimeout(() => {
                    successModal.style.display = 'none';
                    successModal.style.opacity = '1';
                }, 300);
            }, 2000);
        }
        
    </script>

    {% if error_message %}
    <div class="error-message">
        {{ error_message }}
    </div>
    {% else %}
        <!-- existing summary content -->
    {% endif %}
</body>
</html>

<!-- Add a dedicated Copy Success Modal at the end of the body -->
<div id="copySuccessModal" class="copy-success-modal" style="display: none;">
    <div class="copy-success-content">è¤‡è£½éˆæ¥æˆåŠŸï¼</div>
</div>



